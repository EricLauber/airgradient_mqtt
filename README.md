# AirGradient MQTT

This is an Arduino sketch for the AirGradient DIY Air Quality Sensor Pro, PCB version 4.2. 

The base configuration for an AirGradient product is for it to log data to AirGradient's servers. This sketch replaces that functionality with MQTT capabilities to log data to a server of your choice.

## References

AirGradient provides several resources for DIY support and customization.

- [DIY Pro 4.2 build instructions](https://www.airgradient.com/open-airgradient/instructions/diy-pro-v42/)
- [DIY Pro Presoldered 4.2 build instructions](https://www.airgradient.com/open-airgradient/instructions/diy-pro-presoldered-v42/)
- [AirGradient PCB and 3D Printer files](https://www.airgradient.com/open-airgradient/instructions/overview/)
- [AirGradient Example 4.2 sketch](https://github.com/airgradienthq/arduino/blob/master/examples/DIY_PRO_V4_2/DIY_PRO_V4_2.ino)

There are several forks of the original [AirGradient arduino repo](https://github.com/airgradienthq/arduino/) that add alternative capabilities that I used for reference.

- [JHadley1406 / aigradient_arduino](https://github.com/JHadley1406/airgradient_arduino)
- [hjburke / airgradient-mqtt](https://github.com/hjburke/airgradient-mqtt)
- [nsbk / airgradient_mqtt](https://github.com/nsbk/airgradient_mqtt)
- [agileek / AirGradientHomeAssistant](https://github.com/agileek/AirGradientHomeAssistant)
- [geerlingguy / airgradient-prometheus](https://github.com/geerlingguy/airgradient-prometheus)
- [Jeff Geerling - Monitoring my home's air quaity (CO2, PM2.5, Temp/Humidity) with AirGradient's DIY sensor](https://www.jeffgeerling.com/blog/2021/airgradient-diy-air-quality-monitor-co2-pm25)

## Configuration

TODO - update this section!

Update the `arduino_config.h` file with your details.

- `SECRET_SSID`: WiFi ssid
- `SECRET_PASS`: WiFi password
- `MQTT_SERVER_ADDRESS`: The MQTT server address, you can use `test.mosquitto.org`
- `IP_LAST_CHUNK`: 
- `MQTT_TOPIC`: The MQTT topic that the values will be published to. Recommendation: one topic per device.
- `DEVICE_ID`: A friendly name for your device
- `TEMP_DEVIATION`: The temperature deviation from the sensor to the room. I use 2.5 degrees in my setup. I guess the deviation comes from the heat generated by the board.
- `HUM_DEVIATION`: Same idea as `TEMP_DEVIATION`. I use 2% in my setup. 

## Home Assistant

TODO - update this section!

I use Home Assistant to track and display the sensor status. Define the sensors in your `configuration.yaml` as follows:

```yaml
# Air Gradient sensors
mqtt:
  - sensor:
      name: "Room-name Temperature"
      state_topic: "home/roomname/temperature"
      unit_of_measurement: "Â°F"
  - sensor:
      name: "Room-name Humidity"
      state_topic: "home/roomname/humidity"
      unit_of_measurement: "%"
  - sensor:
      name: "Room-name NOX Index"
      state_topic: "home/roomname/nox_index"
  - sensor:
      name: "Room-name TVOC Index"
      state_topic: "home/roomname/tvoc_index"
  - sensor:
      name: "Room-name PM 1"
      state_topic: "home/roomname/pm01"
      unit_of_measurement: "ug/m3"
  - sensor:
      name: "Room-name PM 2.5"
      state_topic: "home/roomname/pm25"
      unit_of_measurement: "ug/m3"
  - sensor:
      name: "Room-name AQI"
      state_topic: "home/roomname/pm25AQI"
  - sensor:
      name: "Room-name PM 0.3"
      state_topic: "home/roomname/pm03"
      unit_of_measurement: "ug/m3"
  - sensor:
      name: "Room-name PM 10"
      state_topic: "home/roomname/pm10"
      unit_of_measurement: "ug/m3"
  - sensor:
      name: "Room-name CO2"
      state_topic: "home/roomname/co2"
      unit_of_measurement: "ppm"
```

### general HA setup

1. create a user for mqtt
1. setup the broker. configure it for the user
1. point the publisher or subscriber to the broker. has to be able to call mqtt:// instead of http:// and access the port
1. add sensors to the yaml in home assistant to receive the data based on the topic
1. update the UI to show those sensors

### testing

install the AUnit library with ArduinoIDE

ubuntu system - may be good to go

wel - install g++ and make

clone EpoxyDuino

all files in src because that's where arduino recursively searches and compiles

will need to add a `.env` file to root with the following format:

```bash
arduino_ide_dir=LOCATION_OF_ARDUINO_IDE
```

it is expected that EpoxyDuino will be cloned to the libraries subfolder.

To compile and run tests:

```bash
$ make -C tests clean

$ make -C tests tests
$ make -C tests runtests | grep failed
```
